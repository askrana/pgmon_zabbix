<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title>pgmon_2ndQ</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="pgmon-2ndq">
<h1 class="title">pgmon_2ndQ</h1>

<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id1">Overview</a></li>
<li><a class="reference internal" href="#setting-up-the-monitoring-database-and-and-user" id="id2">Setting up the monitoring database and and user</a></li>
<li><a class="reference internal" href="#setting-up-the-collector" id="id3">Setting up the collector</a></li>
<li><a class="reference internal" href="#configuring-zabbix-to-use-the-collected-data" id="id4">Configuring zabbix to use the collected data</a></li>
</ul>
</div>
<div class="section" id="overview">
<h1><a class="toc-backref" href="#id1">Overview</a></h1>
<p><cite>pgmon_2ndq</cite> is a set of postgresql monitoring functions implemented in the server.</p>
<p>The functions are installed in their own database and connect back to all databases in the
server to get database specific info</p>
<p>A cronjob gets the monitoring info from these functions in a single database call
and saves it to a file</p>
<p>Then zabbix user parameters are used to get the data from this file.</p>
<p>This architecture was chosen to make it easy to control number of connections to database</p>
</div>
<div class="section" id="setting-up-the-monitoring-database-and-and-user">
<h1><a class="toc-backref" href="#id2">Setting up the monitoring database and and user</a></h1>
<p>create monitoring user</p>
<pre class="literal-block">
create user zbx_monuser password 'zbx_monpwd';
grant usage on schema moninfo_2ndq to zbx_monuser;

CREATE DATABASE zbx_mondb;

CREATE USER zbx_monuser
  WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB
  PASSWORD 'zbx_monpwd';
</pre>
<p>connect to monitoring database</p>
<pre class="literal-block">
\c zbx_mondb

CREATE LANGUAGE plpgsql;
CREATE LANGUAGE plpythonu;
</pre>
<p>and load the function definitions:</p>
<pre class="literal-block">
\i mondb_functions.sql
</pre>
<p>your database host must have pl/python language installed.
It is usually either in its own package called something like
postgresql-python or postgresql-plpython.</p>
<p>pl/python makes use of pythons postgresql module psycopg2
to connect to all monitored databases in this server, so
the following needs to succeed when run on the database server:</p>
<pre class="literal-block">
user&#64;host:~/pgmon_zabbix$ python
Python 2.7.3 (default, Aug  1 2012, 05:14:39)
[GCC 4.6.3] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import psycopg2
&gt;&gt;&gt;
</pre>
<p>If it does not work, you need to install psycopg2.
Usually it is in a package python-psycopg2 or similar.</p>
<p>Next, check pg_hba.conf to make sure that the monitoring
user can connect to the monitoring database. ( It may be a good idea
to let it connect to _only_ the monitoring database ).</p>
<p>Test it from the host you are going to run the zabbix
monitoring info collector from</p>
<pre class="literal-block">
psql -h &lt;database host&gt; zbx_mondb zbx_monuser
</pre>
<p>if connecting succeeds, run:</p>
<pre class="literal-block">
select * from moninfo_2ndq.moninfo_full();
</pre>
<p>if this also succeeds, you have successfully configured the
database side of zabbix monitoring for postgresql.</p>
</div>
<div class="section" id="setting-up-the-collector">
<h1><a class="toc-backref" href="#id3">Setting up the collector</a></h1>
<p>first edit ./mon_collector.py and set the PG_* constants to correct values:</p>
<pre class="literal-block">
### configuration
LOGDIR_BASE = &quot;/var/log/pgmon_2ndQ/&quot;
### moninfo files will be kept in LOGDIR_BASE/PG_HOST/PG_PORT
### edit the folowing to connect to your database
MONDB = 'zbx_mondb' # recommendation to use dedicated database
PG_HOST = 'localhost' if (len(sys.argv) &lt; 2 or sys.argv[1].startswith('--')) else sys.argv[1]
PG_PORT = '5432' if (len(sys.argv) &lt; 3 or sys.argv[2].startswith('--')) else sys.argv[2]
PG_USER =  'zbx_monuser'
PG_PWD = 'zbx_monpwd'
##print PG_HOST,PG_PORT,PG_USER
### number of latest logs to keep, 0 - no cleanup
CLEANUP_OLD_LOGS = 5
### end of configuration
</pre>
<p>you have to create the directory LOGDIR_BASE and make it writable by the user
who will be running the cronjob. Probably the best choice is user 'zabbix' as
this is the used which will later consume the collected data</p>
<pre class="literal-block">
sudo mkdir /var/log/pgmon_2ndQ/
sudo chown zabbix /var/log/pgmon_2ndQ/
</pre>
<p>host and port can be specified also when calling the collector script, so you can
use the same script for multiple servers if they are otherways set up in similar manner,
that is the database, user and password are the same.</p>
<p>(You are welcome to contribute support for config files or more command line parameters)</p>
<p>Once done, copy the mon_collector.py to /usr/local/bin and test it</p>
<pre class="literal-block">
sudo -u zabbix mon_collector.py
</pre>
<p>if this rund with no errors, check tat you have the LOGDIR_BASE/PG_HOST/PG_PORT/latest file.</p>
<p>if this is also ok generate the user parameters for zabbix</p>
<blockquote>
sudo -u zabbix mon_collector.py --UserParameter.conf &gt; /tmp/zabbix.userparam.conf
sudo bash -c &quot;cat /tmp/zabbix.userparam.conf &gt;&gt; /etc/zabbix/zabbix_agentd.conf&quot;</blockquote>
<p>and restart zabbix agents</p>
<pre class="literal-block">
sudo /etc/init.d/zabbix-agent restart
</pre>
<p>as a last step add mon_collector.py to crontab of user zabbix</p>
<pre class="literal-block">
sudo -u zabbix crontab -e
</pre>
<p>and add line</p>
<blockquote>
<ul class="simple">
<li><ul class="first">
<li><ul class="first">
<li><ul class="first">
<li><ul class="first">
<li>/usr/local/bin/mon_collector.py</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>to get collect monitoring info every minute</p>
<p>see if you start getting new files in LOGDIR_BASE/PG_HOST/PG_PORT/ each minute</p>
<p>if not, check mail for zabbix user for cron errors</p>
<pre class="literal-block">
sudo -u zabbix mail
</pre>
</div>
<div class="section" id="configuring-zabbix-to-use-the-collected-data">
<h1><a class="toc-backref" href="#id4">Configuring zabbix to use the collected data</a></h1>
<p>Import the provided template into zabbix</p>
<p>in Configuration/Templates screen click Import.</p>
<p>Then select the Template_PostgreSQL_2ndQuadrant_3.xml file and import it</p>
<p>Finally activate &quot;PostgreSQL servers&quot; from Configuration/HostGroups</p>
<p>And you should be done now!</p>
</div>
</div>
</body>
</html>
